<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - School Management System</title>
    <link rel="stylesheet" href="/css/admin.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
    />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="text-center mb-4">
        <h4 class="text-white">Admin Panel</h4>
      </div>
      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="/admin">
            <i class="bi bi-speedometer2"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/admission">
            <i class="bi bi-person-plus"></i> Admissions
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/student">
            <i class="bi bi-mortarboard"></i> Students
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/teacher">
            <i class="bi bi-person-workspace"></i> Teachers
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/notice">
            <i class="bi bi-megaphone"></i> Notices
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/payments">
            <i class="bi bi-credit-card"></i> Payments
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/login/logout">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Dashboard Section -->
      <div id="dashboard" class="section">
        <h2 class="mb-4">Dashboard</h2>

        <!-- Stats Row -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-primary">
                <i class="bi bi-mortarboard"></i>
              </div>
              <div class="stat-value"><%= Students.length %></div>
              <div class="stat-label">Total Students</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-success">
                <i class="bi bi-person-workspace"></i>
              </div>
              <div class="stat-value"><%= Teachers.length %></div>
              <div class="stat-label">Total Teachers</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-warning">
                <i class="bi bi-file-earmark-text"></i>
              </div>
              <div class="stat-value"><%= pendingAdmissions.length %></div>
              <div class="stat-label">Pending Admissions</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-info">
                <i class="bi bi-calendar-event"></i>
              </div>
              <div class="stat-value"><%= ActiveNotice.length %></div>
              <div class="stat-label">Active Notices</div>
            </div>
          </div>
        </div>

        <!-- Notices Section -->
        <div class="row">
          <div class="col-md-6">
            <h3 class="mb-3">Recent Notices</h3>
            <% Notice.forEach(function(notice) { %> <% if(notice.status ===
            "Active") { %>
            <div class="notice-card col-6">
              <div class="notice-title"><%= notice.title %></div>
              <div class="notice-content"><%= notice.remark %></div>
              <div class="notice-date">Date: <%= notice.date %></div>
            </div>
            <% } else { %>
            <div class="notice-card col-6">
              <a href="/admin/notice" class="nav-link">
                Click me to Add new Notice</a
              >
            </div>
            <% } %> <% }); %>
          </div>

          <div class="col-md-6">
            <h3 class="mb-3">Pending Admissions</h3>
            <div class="data-table">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Class</th>
                    <th>Date</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <% Admissions.forEach(function(admission) { %> <% if
                  (admission.status === "Pending") { %>
                  <tr>
                    <td><%= admission.name %> <%= admission.lastname %></td>
                    <td><%= admission.grade %></td>
                    <td><%= admission.createdAt %></td>
                    <td>
                      <span class="badge bg-warning"
                        ><%= admission.status %></span
                      >
                    </td>
                  </tr>
                  <% } %> <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12 mt-4">
            <h3 class="mb-3">Teacher Leave Applications</h3>
            <div class="leave-table">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Teacher ID</th>
                    <th>From Date</th>
                    <th>To Date</th>
                    <th>Reason</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% TeacherLeaves.forEach(function(leave) { %>
                  <tr data-leave-id="<%= leave._id %>">
                    <td><strong><%= leave.teacherId %></strong></td>
                    <td>
                      <%= new Date(leave.fromDate).toLocaleDateString() %>
                    </td>
                    <td><%= new Date(leave.toDate).toLocaleDateString() %></td>
                    <td><%= leave.reason %></td>
                    <td>
                      <span
                        class="leave-status-badge <%= leave.status.toLowerCase() %>"
                      >
                        <%= leave.status %>
                      </span>
                    </td>
                    <td>
                      <% if(leave.status === 'Pending') { %>
                      <div class="leave-actions">
                        <div class="btn-group" role="group">
                          <button
                            type="button"
                            class="btn btn-success btn-sm"
                            onclick="approveLeave('<%= leave._id %>')"
                            title="Approve Leave"
                          >
                            <i class="bi bi-check-circle"></i> Approve
                          </button>
                          <button
                            type="button"
                            class="btn btn-danger btn-sm"
                            onclick="rejectLeave('<%= leave._id %>')"
                            title="Reject Leave"
                          >
                            <i class="bi bi-x-circle"></i> Reject
                          </button>
                        </div>
                      </div>
                      <% } else { %>
                      <span class="text-muted">No actions available</span>
                      <% } %>
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="/js/responsive.js"></script>
    <script>
      // Leave management functions
      function showLeaveMessage(message, type = "success") {
        // Remove existing messages
        const existingMessages = document.querySelectorAll(".leave-message");
        existingMessages.forEach((msg) => msg.remove());

        // Create new message
        const messageDiv = document.createElement("div");
        messageDiv.className = `leave-message ${type}`;
        messageDiv.textContent = message;

        document.body.appendChild(messageDiv);

        // Auto remove after 3 seconds
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.remove();
          }
        }, 3000);
      }

      async function approveLeave(leaveId) {
        try {
          const response = await fetch("/admin/teacher-leave/approve", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ leaveId, status: "Approved" }),
          });
          if (!response.ok) {
            throw new Error("Failed to approve leave");
          }
          await fetchAndRenderAttendance(selectedTeacherId);
        } catch (error) {
          console.error("Error approving leave:", error);
          alert("Error approving leave. Please try again.");
        }
      }

      async function rejectLeave(leaveId) {
        try {
          const response = await fetch("/admin/teacher-leave/approve", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ leaveId, status: "Rejected" }),
          });
          if (!response.ok) {
            throw new Error("Failed to reject leave");
          }
          await fetchAndRenderAttendance(selectedTeacherId);
        } catch (error) {
          console.error("Error rejecting leave:", error);
          alert("Error rejecting leave. Please try again.");
        }
      }
      function updateLeaveRow(leaveId, status) {
        const row = document.querySelector(`tr[data-leave-id="${leaveId}"]`);
        if (row) {
          // Update status badge
          const statusCell = row.querySelector(".leave-status-badge");
          if (statusCell) {
            statusCell.textContent = status;
            statusCell.className = `leave-status-badge ${status.toLowerCase()}`;
          }

          // Update actions cell
          const actionsCell = row.querySelector("td:last-child");
          if (actionsCell) {
            actionsCell.innerHTML =
              '<span class="text-muted">No actions available</span>';
          }
        }
      }

      // Enhanced table functionality
      document.addEventListener("DOMContentLoaded", function () {
        // Add hover effects to table rows
        const tableRows = document.querySelectorAll(".table tbody tr");
        tableRows.forEach((row) => {
          row.addEventListener("mouseenter", function () {
            this.style.backgroundColor = "rgba(26, 35, 126, 0.05)";
          });

          row.addEventListener("mouseleave", function () {
            this.style.backgroundColor = "";
          });
        });

        // Add responsive table wrapper if needed
        const tables = document.querySelectorAll(".table");
        tables.forEach((table) => {
          if (!table.parentElement.classList.contains("table-responsive")) {
            const wrapper = document.createElement("div");
            wrapper.className = "table-responsive";
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
          }
        });
      });
    </script>
  </body>
</html>
